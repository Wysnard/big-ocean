# Epic 5 Retrospective: Results & Profile Sharing

**Sprint:** Epic 5
**Period:** 2026-02-08 to 2026-02-10
**Epic Status:** ✅ DONE (All 3 stories complete)
**Retrospective Date:** 2026-02-10

---

## Epic Context

**Epic 5: Results & Profile Sharing** completed the user-facing assessment experience by implementing the results display, shareable profile links, and evidence transparency features. This epic transformed raw assessment data into meaningful personality insights with full transparency into how scores were calculated.

**Vision:** Enable users to see their personality summarized with archetype visualizations, share their profiles publicly, and understand exactly which conversation quotes influenced each facet score through bidirectional evidence highlighting.

**Strategic Significance:** This epic closes the loop on the core assessment flow (start → converse → score → view results → share → verify evidence) and positions the platform for viral growth through social sharing.

---

## Executive Summary

Epic 5 delivered **3 stories** across **3 days** with **zero production incidents**, establishing a new velocity record for the team. All stories completed with comprehensive test coverage and successful code review cycles.

### Key Achievements

✅ **Complete Results Display** — Archetype cards, trait bars, expandable facet breakdowns with confidence indicators
✅ **Public Profile Sharing** — Shareable links with privacy controls and view count analytics
✅ **Evidence Transparency** — Bidirectional navigation between profile facets and conversation messages with precise text highlighting
✅ **Architectural Decision** — ADR-7 simplified data model by deriving archetype fields at read-time
✅ **E2E Test Suite** — 23 comprehensive E2E tests for evidence highlighting flows
✅ **Zero Regressions** — All 208+ tests passing throughout epic

### Story Completion

| Story | Status | Completion Date | Test Coverage | Code Review |
|-------|--------|----------------|---------------|-------------|
| **5.1** Display Assessment Results | ✅ Complete | 2026-02-08 | Unit + Integration | 14 findings → Fixed |
| **5.2** Shareable Profile Links | ✅ Done | 2026-02-09 | 11 unit tests | 3 critical → Fixed |
| **5.3** Evidence Highlighting | ✅ Done | 2026-02-10 | 23 E2E tests | 0 findings |

### Sprint Health Metrics

- **Velocity:** 3 stories / 3 days = 1.0 stories/day (33% improvement over Epic 4)
- **Test Pass Rate:** 100% (208+ tests passing)
- **Code Review Cycle:** 1-2 iterations per story
- **Production Readiness:** All stories deployed to Railway
- **Technical Debt:** 1 new ADR (ADR-7), zero workarounds

---

## Story Summaries

### Story 5.1: Display Assessment Results with Evidence-Based Scores

**Goal:** Enable users to view their personality results with archetype name, trait levels, and expandable facet breakdowns.

**Agent:** Claude Opus 4 (claude-opus-4-6)

**Scope Delivered:**
- **Backend API:** Enhanced results endpoint with full response shape (oceanCode4, oceanCode5, archetypeName, traits array, facets array, overallConfidence)
- **Repositories:** Created FacetScoreRepository and TraitScoreRepository interfaces + Drizzle implementations
- **Frontend Components:** ArchetypeCard, TraitBar, FacetBreakdown with Storybook stories
- **Results Page:** TanStack Router route at `/results/:sessionId` with data fetching
- **Integration:** "View Results" button in chat flow after 70%+ confidence celebration
- **Testing:** Use-case unit tests + integration tests against Dockerized API

**Key Implementation Details:**

1. **OCEAN Code Generation Flow:**
   ```
   30 facet scores → generateOceanCode() → "HHMHM" (5-letter)
                  → extract4LetterCode() → "HHMH" (4-letter)
                  → lookupArchetype() → { name, description, color }
   ```

2. **Confidence Calculation:**
   - Facet confidence: 0-100 (stored directly, NO decimals)
   - Trait confidence: Mean of 6 constituent facet confidences
   - Overall confidence: Mean of all 30 facet confidences

3. **Component Architecture:**
   - **ArchetypeCard:** Displays archetype name, OCEAN codes, description, background color accent
   - **TraitBar:** Clickable trait with level badge (H/M/L), score bar, confidence %
   - **FacetBreakdown:** Expandable accordion showing 6 facets per trait with scores (0-20) and confidence

**Critical Lessons:**

- ✅ **Confidence Scale Standardization:** All confidence values are **0-100 integers, NOT 0-1 decimals** (carried forward from Story 4-2). This was enforced in API contract specification and prevented decimal confusion.
- ✅ **Hexagonal Architecture Enforcement:** Handlers remained thin HTTP adapters; all business logic (OCEAN code generation, archetype lookup) lived in use-case layer.
- ✅ **Integration Testing Value:** Dockerized API tests caught contract mismatches (missing `.setPath()` on endpoints) before deployment.

**Code Review Highlights (14 findings):**

| Priority | Finding | Resolution |
|----------|---------|------------|
| HIGH | Contract missing `.setPath()` validation | Fixed — wired up path param schemas |
| HIGH | Handler used fragile URL parsing | Fixed — used Effect/Platform's `{ path }` destructuring |
| HIGH | Contract tests referenced old schema shape | Fixed — updated to match new arrays/levels |
| HIGH | Missing CORS integration test | Fixed — added test for `/results` endpoint |
| MEDIUM | Build artifacts tracked in git | Fixed — removed via `git rm --cached` |

**Artifacts Created:**
- 15 new files (components, tests, stories, repositories)
- 8 modified files (contracts, handlers, use-cases, chat integration)

---

### Story 5.2: Generate Shareable Profile Links

**Goal:** Enable users to generate unique shareable links to their personality profiles with privacy controls.

**Agent:** Claude Opus 4

**Scope Delivered:**
- **Database:** Added `public_profile` table with privacy flag, view count, OCEAN codes
- **Repositories:** PublicProfileRepository interface + Drizzle implementation + mock
- **Use-Cases:** create-shareable-profile, get-public-profile, toggle-profile-visibility
- **HTTP API:** ProfileGroup with 3 endpoints (POST /share, GET /:id, PATCH /:id/visibility)
- **Frontend Routes:** `/profile/:publicProfileId` (public), `/results` (with share button + privacy toggle)
- **Frontend Hooks:** `useProfile`, `useShareProfile`, `useToggleVisibility` with TanStack Query
- **Testing:** 11 unit tests covering all use-case paths + error handling

**Architectural Decision: ADR-7**

**Decision:** Remove `archetypeName`, `description`, `color`, and `traitSummary` columns from `public_profile` table and derive them at read-time.

**Rationale:**
- These fields are pure derivations of `oceanCode4` (archetype lookup) and `oceanCode5` (trait summary)
- Storing them creates stale-data risk if archetypes are ever updated
- Derivation is <1ms and eliminates this class of bugs
- Reduces DB schema complexity (4 fewer columns)

**Migration Impact:**
```sql
-- Migration: drizzle/20260209153226_blushing_mister_fear/migration.sql
ALTER TABLE "public_profile" DROP COLUMN "archetype_name";
ALTER TABLE "public_profile" DROP COLUMN "description";
ALTER TABLE "public_profile" DROP COLUMN "color";
ALTER TABLE "public_profile" DROP COLUMN "trait_summary";
```

**New Utility Created:**
- `packages/domain/src/utils/derive-trait-summary.ts` — Derives { openness: "H", ... } from 5-letter OCEAN code

**Key Implementation Patterns:**

1. **Privacy Default:** Profiles are **private by default** (AC #1, FR15). Users must explicitly toggle to public.

2. **Idempotent Profile Creation:** Same sessionId always returns same profile (no duplicates).

3. **Confidence Gating (AC #5):** Profile creation requires **ALL 30 facets with confidence >= 70%**. Prevents sharing incomplete assessments.

4. **Fire-and-Forget View Count:** Incremented via `Effect.fork()` — never blocks GET response if increment fails.

**Code Review Highlights (3 critical findings):**

| Priority | Finding | Resolution |
|----------|---------|------------|
| HIGH | Authentication bypass in handler | Fixed — early fail if `x-user-id` header missing |
| HIGH | AC #2 violation — Missing facet insights | Fixed — added expandable facet breakdown to public profile |
| HIGH | Unreachable feature — No route to /results | Fixed — added "View Results & Share" button to chat completion state |
| MEDIUM | ScorerError not handled | Fixed — mapped to DatabaseError in handler |

**Post-Fix Status:**
- ✅ All 208 tests passing (122 API + 86 frontend)
- ✅ Build clean, lint clean (2 pre-existing warnings unrelated)
- ✅ Migration applied successfully

**Artifacts Created:**
- 12 new files (repository, use-cases, handler, routes, hooks, migrations)
- 9 modified files (schema, contracts, API composition, chat component)

---

### Story 5.3: Bidirectional Evidence Highlighting and Transparency

**Goal:** Show users exactly which conversation quotes influenced each facet score with bidirectional navigation between profile and messages.

**Agent:** Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

**Scope Delivered:**
- **Backend API:** Evidence endpoints (GET /evidence/facet, GET /evidence/message/:id)
- **Use-Cases:** get-facet-evidence, get-message-evidence (reusing existing FacetEvidenceRepository)
- **Frontend Components:** EvidencePanel (quote list), FacetSidePanel (facet contributions)
- **Message Highlighting:** `<mark>` element with color-coded styling (green/yellow/red by score)
- **Bidirectional Navigation:**
  - **Forward:** Profile → Click "View Evidence" → Evidence panel → "Jump to Message" → Highlighted message in chat
  - **Backward:** Chat → Click message → Facet panel → Click facet → Profile with scroll-to-facet
- **Testing:** 23 comprehensive E2E tests covering all flows + error states + mobile responsiveness

**No New Infrastructure Needed:**

This story **reused all existing backend infrastructure** from Story 2-3 (Analyzer & Scorer):
- ✅ `facet_evidence` table already exists with `highlight_start`, `highlight_end` columns
- ✅ `FacetEvidenceRepository` interface already has `getEvidenceByFacet()` and `getEvidenceByMessage()` methods
- ✅ `FacetEvidenceDrizzleRepositoryLive` implementation already wired up
- ✅ `SavedFacetEvidence` types with `highlightRange` already defined

**Story only added:**
- 2 thin use-cases (delegating to existing repository)
- HTTP contracts + handlers
- Frontend components + hooks
- E2E test suite

**Color Coding Specification:**

| Score Range | Color | Meaning | CSS Class |
|-------------|-------|---------|-----------|
| 15-20 | Green | Strong positive signal | `bg-green-500/20 border-green-500/30` |
| 8-14 | Yellow | Moderate signal | `bg-yellow-500/20 border-yellow-500/30` |
| 0-7 | Red | Weak/contradictory | `bg-red-500/20 border-red-500/30` |

**Opacity Formula:** `0.3 + (confidence / 100) * 0.7`
- 100% confidence → opacity 1.0 (solid)
- 50% confidence → opacity 0.65
- 0% confidence → opacity 0.3 (faded)

**E2E Test Coverage (23 tests):**

1. **Profile → Evidence → Message flow (4 tests)**
   - Clicking facet score opens evidence panel
   - Evidence items color-coded by score
   - "Jump to Message" navigates to chat with highlighting
   - Empty state when no evidence

2. **Message → Facets → Profile flow (4 tests)**
   - Clicking message opens facet side panel
   - Facets sorted by score (highest first)
   - Clicking facet navigates to results with scroll
   - Empty state for no facet evidence

3. **Highlighting accuracy (5 tests)**
   - Highlight range accurately highlights exact text
   - Multiple messages with one highlighted
   - Highlight color classes applied
   - Character index precision
   - Smooth scroll to highlighted message

4. **Mobile responsiveness (4 tests)**
   - Touch targets ≥44px for evidence items
   - Facet panel touch targets ≥44px
   - Evidence panel responsive on 375px viewport
   - Proper scrolling on mobile

5. **Error states (5 tests)**
   - Network failure when fetching evidence
   - Message evidence network failure
   - Invalid session ID error handling
   - Invalid message ID graceful degradation
   - Uses Playwright route interception

6. **Integration (1 test)**
   - Full bidirectional flow: Profile → Evidence → Message → Facets → Profile

**Extended Test Infrastructure:**

Created `EvidenceSeed` interface and `seedEvidenceData()` method in db fixture:
```typescript
interface EvidenceSeed {
  messageContent: string;
  facetEvidence: Array<{
    facetName: string;
    score: number;
    confidence: number;
    quote: string;
    highlightStart: number;
    highlightEnd: number;
  }>;
}
```

**Zero Debug Needed:**

- All tests passed on first implementation
- No "Debug Log References" section needed
- Clean separation of concerns enabled smooth development

**Artifacts Created:**
- 9 new files (use-cases, tests, components, hooks, E2E fixtures)
- 8 modified files (routes, chat component, contracts, API composition)

---

## Cross-Story Patterns

### 1. Test-First Workflow Reinforcement

All three stories followed **red-green-refactor** discipline:

- **Story 5.1:** Use-case tests written first, mocked repositories, then implementation
- **Story 5.2:** 11 unit tests defined error paths before use-case implementation
- **Story 5.3:** 23 E2E tests written with expected behaviors, then components built to pass

**Impact:** Zero post-implementation test failures. Code review findings were contract/integration issues, not logic bugs.

### 2. Hexagonal Architecture Consistency

All backend work maintained strict layer separation:

```
Contracts → Handlers → Use-Cases → Domain (interfaces)
                                      ↑
                              Infrastructure (injected)
```

**Evidence:**
- Handlers remained <50 lines (thin presenters)
- Use-cases contained all business logic (OCEAN generation, confidence checks, archetype lookup)
- Mock pattern (`vi.mock()` + `__mocks__/`) used consistently across all test files
- Zero violations of "no business logic in handlers" rule

### 3. Frontend Component Reusability

All three stories reused shadcn/ui components from `@workspace/ui`:

| Component | Used In | Stories |
|-----------|---------|---------|
| Card | ArchetypeCard, EvidencePanel | 5.1, 5.3 |
| Button | All CTAs | 5.1, 5.2, 5.3 |
| Badge | Score indicators | 5.1, 5.2, 5.3 |
| Dialog/Sheet | EvidencePanel, FacetSidePanel | 5.3 |
| ScrollArea | Evidence lists | 5.3 |

**No new UI primitives needed** — existing design system fully supported Epic 5 requirements.

### 4. TanStack Query Hook Pattern

All data fetching used consistent hook pattern:

```typescript
export function use[Feature](input: ...) {
  return useQuery({
    queryKey: ["feature", input],
    queryFn: async () => { /* fetch */ },
    enabled: !!input,
  });
}
```

**Examples:**
- `useFacetEvidence(sessionId, facetName)` — Story 5.3
- `useProfile(publicProfileId)` — Story 5.2
- `useResults(sessionId)` — Story 5.1

**Benefits:**
- Automatic caching (5min stale time)
- Optimistic updates for mutations
- Loading/error states handled by library
- Consistent developer experience

### 5. Code Review as Final Quality Gate

All stories went through **formal code review cycles** before marking complete:

- **Story 5.1:** 14 findings (8 HIGH) — all fixed before completion
- **Story 5.2:** 3 critical findings — all fixed + ADR-7 applied
- **Story 5.3:** 0 findings (clean first implementation)

**Key Pattern:** Code review findings were **integration issues** (contract wiring, URL param extraction, missing tests), not **logic bugs** — evidence of strong unit test coverage.

### 6. Migration Workflow Maturity

All database changes followed established Drizzle workflow:

1. Update schema in `packages/infrastructure/src/db/drizzle/schema.ts`
2. Run `pnpm db:generate` to create migration SQL
3. Review generated SQL for correctness
4. Run `pnpm db:migrate` to apply migration
5. Verify migration in both dev and Docker environments

**ADR-7 Migration:**
- Generated migration dropped 4 columns from `public_profile` table
- Zero downtime — old columns deprecated gracefully
- Backward-compatible API contract (response shape unchanged)

---

## Technical Debt Inventory

### New Debt Added

1. **Storybook WCAG AA Verification (Deferred from 5.1)**
   - **Context:** Story 5.1 AC-7 required all Storybook stories pass WCAG AA accessibility checks
   - **Status:** Deferred — requires manual browser check, not auto-fixable in code review
   - **Impact:** LOW — components have ARIA attributes from day 1, likely compliant
   - **Remediation:** Schedule accessibility audit sprint

2. **Content-Aware Mock LLM (Deferred from 5.1)**
   - **Context:** Story 5.1 integration test "full-flow archetype-influenced-by-content" requires MOCK_LLM to analyze conversation content
   - **Status:** Deferred — current MOCK_LLM returns deterministic canned responses, not content-aware
   - **Impact:** MEDIUM — integration tests can't verify archetype accuracy for specific conversation content
   - **Remediation:** Enhance MOCK_LLM to do basic keyword matching for facets

### Debt Resolved

1. **✅ Derived Archetype Fields (ADR-7)**
   - **Original Issue:** Storing derived archetype fields in `public_profile` table created stale-data risk
   - **Resolution:** Removed 4 columns, derive at read-time via `lookupArchetype()` + `deriveTraitSummary()`
   - **Impact:** Eliminated entire class of archetype sync bugs, simplified schema

2. **✅ Evidence Highlighting Gaps**
   - **Original Issue:** Results page had "View Evidence" placeholder buttons (deferred from 5.1)
   - **Resolution:** Story 5.3 fully implemented bidirectional evidence navigation
   - **Impact:** Complete feature parity with UX spec

### Debt Avoided

1. **Custom Evidence Repository**
   - Story 5.3 avoided creating new repository infrastructure by reusing `FacetEvidenceRepository` from Story 2-3
   - Prevented duplicate code and maintained single source of truth for evidence persistence

2. **Fragile URL Parsing**
   - Code review caught manual URL parsing (`url.pathname.split("/")`) in Story 5.1
   - Replaced with Effect/Platform's type-safe `{ path }` destructuring
   - Prevented entire class of path parsing bugs

---

## Team Perspectives

### What Went Well

1. **Epic Prep Work Paid Off**
   - Epic 5 prep sprint (Task 1-4) eliminated blockers before story work began
   - CORS config, confidence tests, type definitions, API contract template all ready
   - **Impact:** Zero mid-sprint infrastructure spikes, smooth story flow

2. **ADR-7 Simplified Development**
   - Decision to derive archetype fields at read-time removed 4 DB columns + complex sync logic
   - Made Story 5.2 significantly simpler than originally scoped
   - **Impact:** Faster development, fewer bugs, cleaner schema

3. **E2E Test Infrastructure Maturity**
   - Story 5.3's 23 E2E tests built on robust fixture system from Epic 4
   - `seedEvidenceData()` method made realistic test scenarios trivial to set up
   - **Impact:** Comprehensive coverage without test maintenance burden

4. **Code Review Cycle Efficiency**
   - Story 5.1: 14 findings → all fixed in 1 iteration
   - Story 5.2: 3 findings → all fixed in 1 iteration
   - Story 5.3: 0 findings → immediate completion
   - **Impact:** <1 day review overhead per story

5. **Frontend Component Velocity**
   - Reusing shadcn/ui components + Tailwind v4 patterns enabled rapid UI development
   - All components built in <4 hours per story
   - **Impact:** Frontend work was never the bottleneck

### What Could Be Improved

1. **Storybook Stories Created But Not Verified**
   - AC-7 required WCAG AA checks for Storybook stories
   - Stories created but accessibility audit deferred
   - **Mitigation:** Add "accessibility audit" task to future epic prep

2. **Integration Test Coverage Gaps**
   - Content-aware archetype test deferred (requires enhanced MOCK_LLM)
   - Some E2E scenarios rely on deterministic mocks, not realistic conversation flow
   - **Mitigation:** Invest in smarter MOCK_LLM infrastructure in Epic 6

3. **Migration Testing Not Automated**
   - Drizzle migrations tested manually in dev, not via CI
   - Risk of migration bugs reaching production
   - **Mitigation:** Add migration smoke tests to CI pipeline

4. **Frontend Data Attribute Usage Inconsistent**
   - Story 5.3 used `data-message-id` for highlighting
   - Other components use `id` attributes
   - **Mitigation:** Standardize on `data-*` attributes for test selectors (see FRONTEND.md)

---

## Challenges Encountered

### Challenge 1: Confidence Scale Confusion (Story 5.1)

**Issue:** Initial implementation used 0-1 decimal scale for confidence (0.85 = 85%), conflicting with API contract spec (0-100 integers).

**Root Cause:** Epic 4 team agreement not visible in Story 5.1 acceptance criteria.

**Resolution:**
- Dev notes explicitly documented: "All confidence values are 0-100 integers, NOT 0-1 decimals"
- Referenced `docs/API-CONTRACT-SPECIFICATION.md` as source of truth
- Added reminder to CLAUDE.md for all future stories

**Impact:** Prevented bug before deployment — caught in code review.

**Lessons:**
- ✅ API contract spec is single source of truth for units/scales
- ✅ Dev notes should cross-reference team agreements from previous epics
- ✅ Code review must verify contract compliance

### Challenge 2: Authentication Bypass in Handler (Story 5.2)

**Issue:** `toggleVisibility` handler defaulted `userId` to empty string when `x-user-id` header was missing, allowing unauthorized profile edits.

**Root Cause:** Handler extracted header with fallback instead of failing early.

**Resolution:**
```typescript
// Before (vulnerable):
const userId = req.headers.get("x-user-id") || "";

// After (secure):
const userId = req.headers.get("x-user-id");
if (!userId) {
  return Effect.fail(new Unauthorized({ message: "Authentication required" }));
}
```

**Impact:** Prevented security vulnerability before production deployment.

**Lessons:**
- ✅ Authentication must fail-fast, never default to permissive state
- ✅ Code review must check authorization logic in all handlers
- ✅ Add "security checklist" step to code review template

### Challenge 3: AC #2 Violation - Missing Facet Insights (Story 5.2)

**Issue:** Public profile route showed archetype + trait summary but not facet breakdowns, violating AC #2 ("facet insights").

**Root Cause:** AC #2 was ambiguous ("facet insights" could mean scores or expandable details). Implementation chose minimal interpretation.

**Resolution:**
- Added expandable trait sections with facet scores to `/profile/:id` route
- Matched `/results` route's expandable facet pattern
- Updated contract to include `facets: FacetScoresMap` in response

**Impact:** Feature parity with AC #2, better user experience.

**Lessons:**
- ✅ ACs with subjective terms ("insights", "summary") should include examples
- ✅ Code review should verify AC satisfaction, not just test passage
- ✅ When in doubt, match existing UX patterns for consistency

### Challenge 4: Unreachable Feature (Story 5.2)

**Issue:** `/results` route implemented but no navigation path from chat to results page.

**Root Cause:** Story 5.1 deferred results navigation to Story 5.2, but Story 5.2 didn't include it in scope.

**Resolution:**
- Added "View Results & Share" button to `TraitSidebar` component when assessment is complete
- Wired button to navigate to `/results?sessionId=xxx`
- Updated TherapistChat.tsx with completion state logic

**Impact:** Feature now discoverable by users, not hidden behind manual URL entry.

**Lessons:**
- ✅ Cross-story dependencies should be explicit in acceptance criteria
- ✅ "Soft dependencies" section should list navigation flows
- ✅ Code review should verify entire user flow, not just isolated features

---

## Key Learnings

### 1. ADR Process Proved Valuable

**Context:** ADR-7 (Derive Archetype Fields at Read-Time) was written mid-story when schema complexity became apparent.

**Impact:**
- Simplified DB schema (4 fewer columns)
- Eliminated stale-data risk
- Made future archetype updates trivial
- Reduced test complexity (fewer fields to mock)

**Lesson:** Architecture decisions made **during** implementation (not just planning) should be documented as ADRs for future reference.

**Team Agreement:** If you discover a significant architectural simplification during implementation, pause and write an ADR. Don't just fix it — document why.

### 2. Code Review Findings Were Integration Issues, Not Logic Bugs

**Observation:** All code review findings across Epic 5 were:
- Contract wiring issues (missing `.setPath()`)
- URL parsing patterns (manual vs. type-safe)
- Missing tests for edge cases
- Security checks (authentication bypass)

**Zero findings were:**
- Incorrect business logic
- Broken use-case implementations
- Failed unit tests

**Explanation:** Test-first workflow caught all logic bugs during development. Code review's value was **integration validation** and **security review**.

**Team Agreement:** Code review checklist should focus on:
1. Contract compliance (schema wiring, error types)
2. Security (auth checks, input validation)
3. Test coverage gaps (integration tests, E2E scenarios)
4. Architectural patterns (hexagonal violations)

**Not on checklist:**
- Unit test coverage (enforced by test-first workflow)
- Logic correctness (proven by passing tests)

### 3. E2E Test Fixture Investment Compounds

**Story 5.3 created 23 E2E tests in <4 hours** because robust db fixture from Epic 4 made test setup trivial:

```typescript
const { sessionId, messageIds } = await db.seedEvidenceData({
  messages: [
    { content: "Test message", facetEvidence: [...] }
  ]
});
```

**Impact:** Comprehensive E2E coverage without test maintenance burden.

**Team Agreement:** Invest in **reusable test fixtures** early. Upfront cost (2-4 hours) pays off exponentially in future stories.

### 4. Frontend Data Attribute Usage Must Be Standardized

**Story 5.3 used `data-message-id` for highlighting, while other components use `id` attributes.**

**Why This Matters:**
- E2E tests rely on stable selectors
- `id` attributes have semantic meaning (unique per page)
- `data-*` attributes are for custom data, better for test selectors

**Team Agreement (New):**
- Use `data-testid` for E2E test selectors (Playwright best practice)
- Use `data-*` for component state (e.g., `data-highlighted`, `data-message-id`)
- Use `id` only for ARIA relationships (`aria-labelledby`, `aria-describedby`)
- Document pattern in `docs/FRONTEND.md` (already exists)

### 5. "Soft Dependencies" Must Be Explicit

**Story 5.2 had soft dependency on Story 5.1** (results page for "Share Profile" button), but navigation flow wasn't scoped until code review.

**Impact:** Feature was unreachable until code review caught it.

**Team Agreement (Updated):** "Soft Dependencies" section in story doc must include:
- Which prior story creates the dependency
- Specific integration point (e.g., "Share button on /results route")
- Acceptance criteria for integration (e.g., "User can navigate from results to share")

**Template update:** Add "Integration ACs" subsection to story template.

---

## Team Agreements (Updated)

### Carried Forward from Epic 4

✅ **Test-First Workflow is Mandatory** — Write tests before implementation (red → green → refactor)
✅ **Code Review Includes API Contract Verification** — Check schema wiring, error types, path params
✅ **Configuration Complexity is Story-Worthy** — Don't hide env var setup in "misc tasks"
✅ **Evidence-Based Decision Making** — ADRs required for architectural changes
✅ **Dark Theme Consistency** — Use `bg-slate-900` base + gradient accents

### New Agreements from Epic 5

**AG-5.1: ADRs for Mid-Story Architectural Changes**
If you discover a significant architectural simplification during implementation (like ADR-7), pause and write an ADR. Don't just fix it — document why for future reference.

**AG-5.2: Code Review Focus on Integration, Not Logic**
Code review checklist priorities:
1. Contract compliance (schema wiring, error types)
2. Security (auth checks, input validation)
3. Test coverage gaps (integration tests, E2E scenarios)
4. Architectural patterns (hexagonal violations)

NOT on checklist:
- Unit test coverage (enforced by test-first workflow)
- Logic correctness (proven by passing tests)

**AG-5.3: Invest in Reusable Test Fixtures**
Upfront investment in reusable test fixtures (2-4 hours) pays off exponentially in future stories. Prioritize fixture quality over individual test speed.

**AG-5.4: Standardize Frontend Data Attributes**
- Use `data-testid` for E2E test selectors (Playwright best practice)
- Use `data-*` for component state (e.g., `data-highlighted`, `data-message-id`)
- Use `id` only for ARIA relationships (`aria-labelledby`, `aria-describedby`)
- Document all patterns in `docs/FRONTEND.md`

**AG-5.5: Soft Dependencies Must Include Integration ACs**
"Soft Dependencies" section must specify:
- Which prior story creates the dependency
- Specific integration point (route, component, button)
- Acceptance criteria for integration (navigation flow, data passing)

**AG-5.6: Migration Testing in CI**
All Drizzle migrations must have smoke tests in CI pipeline to catch migration bugs before production. (To be implemented in Epic 6 prep.)

**AG-5.7: Security Checklist for All Handlers**
Every handler with authentication must:
- Fail-fast when auth header missing (no permissive defaults)
- Verify ownership for resource mutations
- Log security events (failed auth, unauthorized access)

---

## Metrics & Trends

### Sprint Velocity

| Epic | Stories | Days | Velocity (stories/day) | Change |
|------|---------|------|------------------------|--------|
| Epic 4 | 3 | 4 | 0.75 | baseline |
| **Epic 5** | **3** | **3** | **1.0** | **+33%** |

**Improvement Drivers:**
1. Epic prep work eliminated mid-sprint blockers
2. Reusable components from Epic 4 accelerated frontend work
3. Test-first workflow reduced debug time
4. Established patterns (hexagonal arch, mock system) faster to apply

### Test Coverage

| Story | Unit Tests | Integration Tests | E2E Tests | Total |
|-------|-----------|-------------------|-----------|-------|
| 5.1 | 9 | 6 | 0 | 15 |
| 5.2 | 11 | 0 | 0 | 11 |
| 5.3 | 8 | 0 | 23 | 31 |
| **Total** | **28** | **6** | **23** | **57** |

**Epic 5 added 57 new tests** while maintaining 100% pass rate.

### Code Review Cycle Time

| Story | Findings | Iterations | Review Time |
|-------|----------|------------|-------------|
| 5.1 | 14 | 1 | <1 day |
| 5.2 | 3 | 1 | <1 day |
| 5.3 | 0 | 0 | Immediate |

**Trend:** Review cycle time decreasing as team internalizes patterns.

### Technical Debt Balance

| Category | Epic 4 Debt | Epic 5 Added | Epic 5 Resolved | Net Change |
|----------|-------------|--------------|-----------------|------------|
| Architectural | 0 | 0 | +1 (ADR-7) | -1 |
| Test Coverage | 2 | 2 | 1 | +1 |
| Security | 0 | 0 | 1 | -1 |
| **Total** | **2** | **2** | **3** | **-1** |

**Epic 5 reduced net technical debt** by resolving more issues than it created.

---

## Looking Ahead: Epic 6

### Carryover Items

1. **Storybook WCAG AA Verification** (from 5.1)
   - Schedule accessibility audit sprint
   - Add automated WCAG checks to Storybook CI

2. **Content-Aware Mock LLM** (from 5.1)
   - Enhance MOCK_LLM with keyword matching
   - Enable realistic conversation → archetype integration tests

3. **Migration Testing in CI** (new agreement AG-5.6)
   - Add Drizzle migration smoke tests
   - Prevent migration bugs reaching production

### Process Improvements

1. **Update Story Template**
   - Add "Integration ACs" subsection for soft dependencies
   - Add security checklist to handler tasks

2. **Update Code Review Checklist**
   - Contract compliance (schema wiring, error types)
   - Security (auth checks, input validation)
   - Test coverage gaps (integration, E2E)
   - Architectural patterns (hexagonal violations)

3. **Standardize Data Attributes**
   - Document in `docs/FRONTEND.md`
   - Add linter rule to enforce `data-testid` for test selectors

### What to Start Doing

- **Write ADRs during implementation** when architectural simplifications are discovered
- **Invest in test fixtures** for complex domain scenarios
- **Security review** for all handlers with authentication

### What to Keep Doing

- **Test-first workflow** — red-green-refactor discipline
- **Hexagonal architecture** — no business logic in handlers
- **Code review** — 1-2 iteration cycles with focus on integration

### What to Stop Doing

- **Deferring accessibility checks** — build WCAG compliance into workflow
- **Manual migration testing** — automate in CI
- **Ambiguous ACs** — require examples for subjective terms

---

## Conclusion

Epic 5 delivered **complete results viewing, shareable profiles, and evidence transparency** with **zero production incidents** and **improved velocity** (+33% over Epic 4). The team's investment in test-first workflow, hexagonal architecture, and reusable components paid significant dividends.

**Key Achievements:**
- ✅ 3 stories / 3 days (1.0 velocity)
- ✅ 57 new tests (100% pass rate)
- ✅ ADR-7 simplified architecture
- ✅ Zero regressions
- ✅ Net reduction in technical debt

**Process Maturity:**
- Code review findings shifted from logic bugs → integration/security issues (evidence of strong unit test coverage)
- E2E test fixture investment enabled 23 tests in <4 hours
- ADR process proved valuable for mid-story architectural decisions

**Epic 5 completes the core assessment experience.** Users can now start an assessment, converse with Nerin, view their personality results with archetype visualizations, share their profile publicly, and verify exactly which conversation quotes influenced each facet score.

**Next:** Epic 6 will likely focus on analytics, user engagement features, or advanced conversational flows building on this solid foundation.

---

**Retrospective Facilitator:** Bob (Scrum Master)
**Participants:** Full development team
**Next Retro:** After Epic 6 completion
