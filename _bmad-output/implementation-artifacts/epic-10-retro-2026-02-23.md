# Epic 10 Retrospective — Conversation Intelligence

**Date:** 2026-02-23
**Facilitator:** Bob (Scrum Master)
**Epic:** 10 — Conversation Intelligence (Stories 10.1–10.6)
**Status:** Complete (6/6 stories done)

---

## Epic Summary

Epic 10 delivered the full conversational intelligence pipeline for the Phase 2 two-tier assessment architecture:

- **10.1:** Conversation Evidence Schema & Repository
- **10.2:** ConversAnalyzer — Haiku Analysis on Every Message
- **10.3:** Formula Functions — Facet Metrics & Steering Target
- **10.4:** Steering Integration — Smart Nerin Responses
- **10.5:** Message-Count Progress & Session Guards
- **10.6:** Cost Tracking & Rate Limiting

**Delivery Metrics:**
- 6/6 stories (100% completion)
- All stories delivered in a single day
- Test count: 509 → 1,227 (+718 tests, 141% growth)
- Code review rounds: 11 total (~2 per story)
- High-severity review issues: 6 (all fixed)
- Production incidents: 0

---

## Team Participants

- Alice (Product Owner)
- Bob (Scrum Master) — facilitator
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- Amelia (Developer Agent)
- Vincentlay (Project Lead)

---

## Successes

1. **Full pipeline delivered:** Evidence extraction → formula scoring → steering → cost tracking — the core product intelligence loop is operational
2. **Exceptional velocity:** 6 stories in one day with zero production incidents
3. **Story 10.3 as gold standard:** Pure domain functions, frozen config, 34 unit tests, near-clean code review — the formula module pattern should be replicated
4. **Sequential knowledge chain:** Each story's dev notes explicitly referenced previous story learnings, enabling smooth handoffs
5. **Infrastructure test pipeline fixed:** Story 10.1 discovered 108 pre-existing tests that were never running in CI — now included in turbo pipeline
6. **Test growth:** 509 → 1,227 tests provides a strong quality foundation

---

## Challenges

1. **Workflow overhead:** Current 6-pass process (create story → adversarial review → write tests → dev → code review → manual verification) is too many handoffs
2. **Error handling scope too broad:** 3/6 stories had `catchAll`/`catchTag` applied too broadly, silently swallowing errors that should have propagated (10.2, 10.5, 10.6)
3. **Mock drift from live implementations:** 4/6 stories had test mocks not matching real interfaces — stale configs, wrong imports, self-referencing packages (10.1, 10.2, 10.4, 10.5)
4. **Type safety shortcuts:** 3/6 stories had unsafe casts, `in` operator checks, or nullable handling issues (10.1, 10.4, 10.5)
5. **Import discipline violations:** 3/6 stories had deep imports or cross-layer architecture violations (10.2, 10.4, 10.6)
6. **CI time approaching 5-minute budget:** Test growth is unsustainable without restructuring
7. **Fat test files:** `send-message.use-case.test.ts` accumulated tests from every story, growing unwieldy
8. **Dev agent repeating same mistake categories:** Same 4 types of issues found in review every story

---

## Key Insights

1. **Encode learnings upfront, don't catch them repeatedly** — review findings should become dev agent instructions, not recurring surprises
2. **Ambiguities must be resolved with the user before dev starts** — the SM agent should ask, not guess
3. **TDD works best in one agent session** — tests and implementation in the same context window eliminates handoff confusion
4. **Mock-to-interface type coupling eliminates an entire class of bugs** — use `Context.Tag.Service<typeof Repo>` to make missing methods a compile error
5. **Test architecture needs the same design attention as production architecture** — split by concern, shared fixtures, prune redundancy
6. **Architecture docs must reflect reality** — stale planning docs mislead agents and waste implementation cycles
7. **Two architecture docs needed** — current-state (what we built) and aspirational (where we're heading), updated every epic

---

## Previous Retro Follow-Through

No previous retrospective for Epic 9 exists. This is the first Phase 2 retrospective.

---

## Workflow Improvement: 6 Passes → 3

### Current Workflow (6 passes)
```
SM creates story → Adversarial review → Write tests → Dev implements → Code review → Manual verification
```

### New Workflow (3 passes)
```
1. SM creates story
   - Inline adversarial self-review
   - Anti-patterns section auto-populated from learnings
   - ASKS USER to clarify major ambiguities before finalizing

2. Dev implements (single session)
   - Reads story + anti-patterns
   - Writes tests FIRST (TDD, concrete assertions)
   - Implements to make tests pass
   - Runs self-check before declaring done

3. Code review (focused on design)
   - Architecture alignment and design decisions
   - Patterns worth replicating
   - Mechanical errors already caught by self-check
```

---

## Action Items

### Process Improvements

| # | Action Item | Owner | Priority | Success Criteria |
|---|-------------|-------|----------|------------------|
| 1 | Streamline story workflow from 6 passes to 3: SM inline review + user clarifications, dev TDD + self-check | Bob (SM) | Critical | Epic 11 stories use new 3-pass workflow |
| 2 | Add anti-patterns section to story template (error scope, mock accuracy, import discipline, type safety) | Bob (SM) | Critical | Every Epic 11 story file contains the section |
| 3 | Dev agent self-check checklist: tests pass, lint clean, grep catchAll scope, grep casts, verify mocks, verify imports, check file list | Amelia (Dev) | Critical | Dev agent runs checklist before marking done |

### Architecture & Documentation

| # | Action Item | Owner | Priority | Success Criteria |
|---|-------------|-------|----------|------------------|
| 4 | Refresh `docs/ARCHITECTURE.md` — current state of codebase as-built | Winston (Architect) + Vincentlay | **CRITICAL PATH** | Agent reading only this doc can understand how system works today |
| 5 | Consolidate aspirational architecture — merge 3 planning files into one unified forward-looking doc | Winston (Architect) | **CRITICAL PATH** | Single file covers all future architecture, no overlap with current-state |
| 6 | Clean up CLAUDE.md — remove stale Phase 1/LangGraph patterns, point to architecture docs | Paige (Tech Writer) | **CRITICAL PATH** | Zero references to LangGraph or Phase 1 orchestration |

### Technical Debt

| # | Action Item | Owner | Priority | Success Criteria |
|---|-------------|-------|----------|------------------|
| 7 | Fix mock typing — enforce `Context.Tag.Service<typeof Repo>` in all `__mocks__/` files | Amelia (Dev) | Parallel | Adding method to any repo interface fails build until mock updated |
| 8 | Test architecture cleanup — split fat files, shared fixtures, prune redundancy, measure CI time | Dana (QA) + Amelia (Dev) | Parallel | No test file >20 tests; CI under 5 minutes |
| 9 | Remove legacy LangGraph dead code (orchestrator.*, checkpointer.*) | Amelia (Dev) | Parallel | Zero orchestrator/LangGraph files remain; all tests pass |

---

## Epic 11 Preparation

### Critical Path (before Epic 11 kickoff)

- [ ] #4 — Current-state architecture doc
- [ ] #5 — Unified aspirational architecture doc
- [ ] #6 — CLAUDE.md cleanup
- [ ] #1 — Workflow improvements (SM + dev agent instructions)
- [ ] #2 — Anti-patterns in story template

### Parallel (during early Epic 11 stories)

- [ ] #7 — Mock typing enforcement
- [ ] #8 — Test architecture cleanup
- [ ] #9 — Legacy LangGraph removal

### Deferred (within Epic 11)

- [ ] Budget reservation ($0.30 at session start) — fits in Story 11.5

### Execution Sequence

1. **Step 1:** Refresh `docs/ARCHITECTURE.md` (current state — audit codebase)
2. **Step 2:** Consolidate aspirational architecture (merge 3 files, strip implemented sections)
3. **Step 3:** Clean CLAUDE.md (remove stale, add references to architecture docs)
4. **Step 4:** Update SM create-story workflow + story template (inline review, user clarification, anti-patterns)
5. **Step 5:** Update dev agent instructions (TDD-first, self-check, anti-patterns)
6. **Step 6:** Validate Epic 11 stories against refreshed architecture — update if needed

### Epic Update Required

Epic 11 stories in `epics.md` were written against planning architecture docs that are stale. After the architecture refresh, review and update Epic 11 story definitions against reality. The SM should re-validate each story's ACs and dev notes before creating implementation-ready story files.

---

## Readiness Assessment

| Area | Status |
|------|--------|
| Testing & Quality | ✅ All 1,227 tests passing, deployed to production |
| Deployment | ✅ Live in production |
| Stakeholder Acceptance | ✅ Vincentlay confirmed satisfied |
| Technical Health | ✅ Stable, no concerns |
| Unresolved Blockers | ⚠️ Architecture docs stale — critical path item before Epic 11 |

---

## Next Steps

1. Execute architecture refresh (Steps 1-3 above)
2. Update workflow and tooling (Steps 4-5)
3. Validate Epic 11 stories against refreshed architecture (Step 6)
4. Begin Epic 11 with new 3-pass workflow
