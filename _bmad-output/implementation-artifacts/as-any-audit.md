# Type Safety Audit: `as any` and `: any` Usage

**Generated:** 2026-02-02
**Updated:** 2026-02-03 (Code Review)
**Story:** 2.7 - TypeScript Compilation, Linting, and Code Quality

## Summary (Post-Review)

| Category | Count | Status | Notes |
|----------|-------|--------|-------|
| Generated Files | 4 | ✅ Skip | Auto-generated (routeTree.gen.ts), excluded from lint |
| Test Mocks | 13 | ✅ Documented | All have `biome-ignore` comments with justification |
| Complex Generics | 1 | ✅ Documented | LangGraph StateGraph with biome-ignore |
| External Library | 3 | ✅ Documented | pg types, pino ESM/CJS, all with biome-ignore |
| Type Index Access | 1 | ✅ Documented | Intentional invalid input test |

**Current State:** All `any` usages are documented with `biome-ignore` comments. Lint passes with 0 warnings.

**Total Documented:** ~22 occurrences with biome-ignore comments

---

## Category 1: Generated Files (SKIP)

These are auto-generated by TanStack Router and should not be modified:

| File | Line | Context |
|------|------|---------|
| `apps/front/src/src/routeTree.gen.ts` | 22, 27, 32, 37, 42 | TanStack Router route tree |

**Action:** Skip - these are regenerated on route changes.

---

## Category 2: Test Mocks (LOW PRIORITY)

Test files using `any` for mock flexibility. These are acceptable with `biome-ignore` comments.

| File | Line | Variable | Justification |
|------|------|----------|---------------|
| `apps/api/src/test-utils/test-layers.ts` | 79 | `updates: any` | Union type complexity in test layer |
| `apps/api/src/test-utils/test-layers.ts` | 114 | `message as any` | Bypass union type complexity |
| `apps/api/src/use-cases/__tests__/start-assessment.use-case.test.ts` | 19, 21 | `mockSessionRepo`, `mockLogger` | Vitest mocks |
| `apps/api/src/use-cases/__tests__/send-message.use-case.test.ts` | 74, 76, 78, 80 | Mock repos/logger/agent | Vitest mocks |
| `apps/api/src/use-cases/__tests__/send-message-precision.use-case.test.ts` | 29, 31, 33, 35 | Mock repos/logger/agent | Vitest mocks |
| `packages/infrastructure/src/repositories/__tests__/scorer.drizzle.repository.test.ts` | 52 | `mockDb as any` | Mock database layer |
| `packages/infrastructure/src/repositories/__tests__/analyzer.claude.repository.test.ts` | 38, 479 | `e: any` | JSON parsing in mock |

**Action:** Already have biome-ignore comments. Low priority for refactoring.

---

## Category 3: Complex Generics (MEDIUM PRIORITY)

Production code where complex generic typing makes proper types difficult:

| File | Line | Code | Issue |
|------|------|------|-------|
| `apps/api/src/llm/therapist.ts` | 412 | `const agent: any = new StateGraph(...)` | LangGraph StateGraph complex generics |

**Action:**
- Investigate if LangGraph exports proper types for StateGraph
- If not, document as acceptable escape hatch with comment explaining why

---

## Category 4: External Library Compatibility (MEDIUM PRIORITY)

Production code interfacing with external libraries that don't have clean types:

| File | Line | Code | Issue |
|------|------|------|-------|
| `packages/infrastructure/src/repositories/logger.pino.repository.ts` | 22 | `(pinoModule as any).default` | Dynamic import ESM/CJS compat |
| `packages/infrastructure/src/context/database.ts` | 43, 46 | `format: any`, `val: any` | pg library type parser |
| `packages/infrastructure/src/repositories/scorer.drizzle.repository.ts` | 239 | `error: any` | Effect.catchAll error typing |

**Action:**
- `logger.pino.repository.ts`: Consider using proper Pino types with conditional import
- `database.ts`: Check if pg exports TypeParser types
- `scorer.drizzle.repository.ts`: Use Effect's error types properly

---

## Category 5: Type Index Access (HIGH PRIORITY - FIX)

Code using `as any` to bypass TypeScript's index access checks:

| File | Line | Code | Fix Strategy |
|------|------|------|--------------|
| `apps/api/src/use-cases/__tests__/save-facet-evidence.use-case.test.ts` | 232 | `"openness_imagination" as any` | Intentional invalid value test - keep |
| `apps/api/src/use-cases/__tests__/calculate-precision.use-case.test.ts` | 197 | `facetScores[name as any]` | Use FacetName type assertion |
| `apps/api/src/use-cases/__tests__/analyzer-scorer-integration.test.ts` | 190-192 | `traitScores[trait as any]` | Use TraitName type assertion |

**Action:**
- Line 232: Keep - intentionally testing invalid input
- Lines 190-197: Replace with proper type guards or keyof assertions

---

## Recommended Fixes (Phase 4)

### High Priority (Fix Now)
1. **Type Index Access in Tests** - Use proper `keyof` types instead of `as any`
2. **scorer.drizzle.repository.ts** - Use Effect error types properly

### Medium Priority (Document)
1. **LangGraph StateGraph** - Add JSDoc comment explaining why any is needed
2. **Pino dynamic import** - Consider typed dynamic import pattern
3. **pg type parser** - Check for library types

### Low Priority (Accept with Comments)
1. **Test mocks** - Already have biome-ignore comments, acceptable for test flexibility

---

## Metrics

- **Production code `any` usage:** 8 occurrences
- **Test code `any` usage:** 13 occurrences
- **Generated code `any` usage:** 4 occurrences (skip)
- **Fixable now:** 3-4 occurrences
- **Acceptable with documentation:** 4-5 occurrences
