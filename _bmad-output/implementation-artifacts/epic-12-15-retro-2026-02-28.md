# Combined Retrospective — Epics 12, 13, 14, 15

**Date:** 2026-02-28
**Facilitator:** Bob (Scrum Master)
**Epics:** 12 (Results Experience), 13 (Monetization & Full Portrait), 14 (Relationship Analysis), 15 (Growth & Operational Safety)
**Status:** Complete (13/13 stories done)

---

## Epic Summary

### Epic 12 — Results Experience (3 stories)
- **12.1:** Results Page & Trait Display
- **12.2:** Bidirectional Evidence Highlighting — HighlightedText component, ConversationTranscript, 7 review issues fixed
- **12.3:** Teaser Portrait Generation & Display — structured Haiku output (JSON), dual storage, portrait reading mode

### Epic 13 — Monetization & Full Portrait (3 stories)
- **13.1:** Purchase Events Schema & Capability Derivation — append-only purchase_events table, pgEnum, deriveCapabilities pure function, 18 unit tests
- **13.2:** Polar.sh Checkout & Webhook Integration — Better Auth Polar plugin, onOrderPaid handler, process-purchase use-case
- **13.3:** Full Portrait Async Generation — portraits table, forkDaemon pattern, placeholder row, lazy retry via staleness. Critical review finding: missing PortraitDrizzleRepositoryLive in production layers

### Epic 14 — Relationship Analysis (4 stories)
- **14.1:** Relationship Credits & Purchase Flow — free_credit_granted on signup, credits endpoint, RelationshipCreditsSection, Polar checkout overlay, 4 E2E specs
- **14.2:** Invitation System — relationship_invitations + relationship_analyses tables, credit consumption transaction, InvitationBottomSheet with QR code, SentInvitationsList
- **14.3:** Invitee Assessment Flow — accept/refuse with atomic PostgreSQL operations, httpOnly invite_token cookie, /invite/$token landing page, Better Auth hooks integration, 10 unit tests
- **14.4:** Relationship Analysis Generation — RelationshipAnalysis domain layer, Sonnet LLM prompt, 7-state RelationshipCard discriminated union, relationship analysis view page

### Epic 15 — Growth & Operational Safety (3 stories)
- **15.1:** Shareable Profile & Public URL — 5-section "Story Scroll" editorial redesign, OG PNG via @resvg/resvg-js, audit logging (profile_access_log table), 442 tests
- **15.2:** Archetype Card Generation — migrated from API to frontend (Satori + Resvg), Nitro server routes
- **15.3:** Waitlist & Circuit Breaker — global daily assessment limit (Redis atomic INCR), waitlist_emails table, fail-open resilience, WaitlistForm component

**Delivery Metrics:**
- 13/13 stories (100% completion)
- Production incidents: 0

---

## Team Participants

- **Bob** — Scrum Master (Facilitator)
- **Alice** — Product Owner
- **Charlie** — Senior Developer
- **Diana** — QA Lead
- **Vincentlay** — Developer / Project Lead

---

## Previous Retro Follow-Through (Epic 11)

Epic 11 retro produced 8 action items. Status entering this retro:

| # | Action Item | Status |
|---|------------|--------|
| 1 | Refresh ARCHITECTURE.md | **Carried over (3rd time)** |
| 2 | Clean CLAUDE.md | **Carried over (3rd time)** |
| 3 | Remove LangGraph dead code | **Carried over (3rd time)** |
| 4 | Sprint parallelism plan | **Done** — sprint-parallelism-plan.md created and used |
| 5 | TDD adoption | **Partial** — inconsistent across stories |
| 6 | Handler-layer boundary enforcement | **Partial** — still recurring in reviews |
| 7 | Code review checklist | **Partial** |
| 8 | Story file completeness | **Not addressed** — led to this retro's key finding |

---

## What Went Well

### Parallelism Planning
The sprint-parallelism-plan from Epic 11's retro was a genuine improvement. The step-based batch model with gating allowed multiple stories to proceed in parallel without conflicts. This was the standout process win across all four epics.

### Strong Architectural Patterns
Several reusable patterns emerged organically across stories:
- **Placeholder row pattern** — used in Stories 12.3, 13.3, 14.4 for async generation (portraits, relationship analyses)
- **Append-only purchase events with capability derivation** — clean separation of event sourcing from derived state (Story 13.1)
- **httpOnly cookie flow** for cross-session identity (Story 14.3)
- **Fire-and-forget audit logging** (Story 15.1)
- **Fail-open resilience** with Redis circuit breaker (Story 15.3)

### Clean Delivery
13 stories across 4 epics delivered with zero production incidents and zero rollbacks. The pipeline from ConversAnalyzer through monetization through relationship analysis through growth tools all integrated cleanly.

---

## What Needs Improvement

### Story Creation Quality
Multiple stories had gaps discovered during implementation or code review that should have been caught at story creation time. Examples:
- Story 13.3: missing PortraitDrizzleRepositoryLive in production layer specification
- Story 14.3: httpOnly cookie flow not fully specified upfront
- Several stories needed adversarial review to catch missing architectural decisions

### TypeScript Errors Caught Too Late
Type errors were only caught in CI (GitHub Actions) — far too late in the feedback loop. The dev agent, review agent, and fix agent should all run typecheck, and it should be added to pre-commit hooks.

### E2E Tests Underutilized
Playwright E2E setup exists but was only used when explicitly requested. Stories 14.1 and 14.4 had E2E specs, but most stories skipped them. Additionally, when E2E tests were written, agents tended to make direct API calls instead of using actual UI interactions (clicks, forms, navigation) — defeating the purpose of end-to-end validation.

### E2E Test Fragmentation
Agents created new isolated test files instead of extending existing user journeys. This duplicates setup, slows the suite, and misses interactions between features.

### Handler-Layer Boundary Violations (Recurring)
Stories 13.2, 14.1, and 15.1 had review findings about business logic leaking into handlers. This has been a recurring theme since Epic 11.

### Three Action Items Carried Over 3x
ARCHITECTURE.md refresh, CLAUDE.md cleanup, and LangGraph dead code removal have been carried over for three consecutive retrospectives. This indicates a broken follow-through process.

### TDD Adoption Still Inconsistent
Some stories (13.1 with 18 unit tests, 15.3 with fail-open tests) showed excellent TDD. Others had tests added after implementation.

---

## Action Items

| # | Action Item | Owner | Priority | Status |
|---|------------|-------|----------|--------|
| **1** | **Mandatory adversarial review on stories** — every story that isn't pure "define constants with architect filter" gets adversarial review before `ready-for-dev` | SM | High | Not started |
| **2** | **Architect critical-only filter** — after adversarial review, architect reviews findings and applies only critical ones | Architect | High | Not started |
| **3** | **Parallelism planning at epic/story creation** — embed dependency mapping and parallel batch identification when breaking epics into stories, not just at sprint-planning time | SM + Architect | High | Not started |
| **4** | **Test state audit** — QA reviews all existing tests for usefulness, overlaps, and gaps across the full codebase | QA | High | **Done** — deleted 10 dead/stale files, fixed Redis mock sync, added 7 new test files (24 tests), refactored E2E duplication |
| **5** | **Agent team pipeline with worktrees** — design step file for automated: create-story → adversarial review → architect filter → dev → typecheck → code review → E2E (real UI) + fix → PR, each in isolated worktree branches using Claude Code agent teams | SM + Dev | High | Not started |
| **6** | **TypeScript errors caught too late** — (a) add typecheck to pre-commit hook, (b) dev/review/fix agents must all run typecheck as mandatory gate at every stage | Dev | High | **(a) Done** — typecheck added to pre-commit hook + turbo task + all packages; (b) Not started |
| **7** | **Mandatory E2E step per story** — Playwright E2E as final gate before PR; tests MUST use actual UI interactions (clicks, forms, navigation), NOT direct API calls; agent MUST extend existing test files and user paths before creating new ones; validates UX from frontend perspective | QA + Dev | High | Not started |
| **8** | **Refresh ARCHITECTURE.md** (carried over x3) — must be done this cycle or explicitly dropped | Dev | Medium | **Done** (d591052) |
| **9** | **Clean CLAUDE.md** (carried over x3) — must be done this cycle or explicitly dropped | Dev | Medium | **Done** (d591052) |
| **10** | **Remove LangGraph dead code** (carried over x3) — must be done this cycle or explicitly dropped | Dev | Medium | **Done** (93925b6, d591052) |
| **11** | **Document placeholder-row pattern** — formalize as architectural pattern in ARCHITECTURE.md (appeared in 3+ stories) | Architect | Low | Not started |
| **12** | **Enforce handler-layer boundary** — add to adversarial review checklist: no business logic in handlers | Architect | Medium | Not started |

---

## Agent Team Pipeline Design (Target)

```
create-story
  → adversarial review
  → architect critical-only filter
  → dev (with typecheck gate)
  → code review (with typecheck gate)
  → E2E run + fix (real UI, extend existing tests)
  → PR
```

Each stage runs in an isolated git worktree with a step file orchestrating the flow. Reference: https://code.claude.com/docs/en/agent-teams

---

## Readiness Assessment

The team is ready to proceed. Key priorities before next epic work:
1. Tackle the 3x carried-over items (8, 9, 10) immediately
2. Add typecheck to pre-commit hook (item 6a)
3. Run test state audit (item 4)
4. Design the agent team pipeline step file (item 5)

---

## Closure

Combined retrospective for Epics 12-15 complete. These four epics represent the full Phase 2 delivery — from results experience through monetization, relationship analysis, and growth tools. The team delivered 13 stories cleanly and identified significant process improvements around story quality gates, E2E testing discipline, and agent team automation.

**Next:** Address carried-over action items, then design the agent team pipeline for future epic execution.
