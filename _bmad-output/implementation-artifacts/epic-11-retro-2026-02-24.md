# Epic 11 Retrospective — Finalization & Scoring

**Date:** 2026-02-24
**Facilitator:** Bob (Scrum Master)
**Epic:** 11 — Finalization & Scoring (Stories 11.1–11.5)
**Status:** Complete (5/5 stories done)

---

## Epic Summary

Epic 11 delivered the complete finalization pipeline — from trigger to scored results with teaser portrait generation:

- **11.1:** Finalization Trigger & Auth Gate — new routes, endpoints, session re-entry routing, lazy finalization removal
- **11.2:** FinAnalyzer Sonnet Integration — full-context re-analysis, highlight computation, 3 new domain repos
- **11.3:** Score Computation & OCEAN Code Generation — pure domain functions wrapping existing formula module
- **11.4:** Archetype System — FacetResult schema extension with level fields
- **11.5:** Finalization Pipeline Orchestration — teaser portrait (Haiku), shared prompt utils, three-tier idempotency completion

**Delivery Metrics:**
- 5/5 stories (100% completion)
- All stories delivered in a single day (2026-02-24)
- Code review rounds: 8 total (~1.6 per story)
- Critical review issues: 3 (all in Story 11.1, all fixed)
- Production incidents: 0
- Models used: Opus 4.6 (Stories 11.1, 11.2, 11.3, 11.5), Opus 4.5 (Story 11.4)

---

## Team Participants

- Alice (Product Owner)
- Bob (Scrum Master) — facilitator
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- Amelia (Developer Agent)
- Vincentlay (Project Lead)

---

## Successes

1. **Full finalization pipeline shipped in one day:** Trigger → FinAnalyzer → scores → teaser portrait → idempotent recovery — the core product loop is complete
2. **Hexagonal architecture payoff:** Story 11.3 wrapped existing `computeFacetMetrics()` from Epic 10 — cleanest story with minimal review fixes, validating the pure domain function investment
3. **Anti-patterns sections worked:** Every story had 6-8 explicit rules. Issue categories are being caught during review
4. **3-pass workflow improvement delivered velocity:** Streamlined from Epic 10's 6-pass process (SM → Dev TDD → Review) worked well
5. **Three-tier idempotency proven:** 28 tests on generate-results covering retry, concurrent requests, partial failures — production-grade resilience
6. **Shared prompt utils extraction (11.5):** `portrait-prompt.utils.ts` enables teaser and full portrait to share formatting logic without duplication
7. **Sequential knowledge chain maintained:** Each story's dev notes referenced previous story learnings, enabling smooth handoffs

---

## Challenges

1. **TDD not consistently followed:** Dev agent gravitates toward implementation-first. Stories without TDD had significantly more review issues (11.1: 10 issues vs 11.3: minimal)
2. **Handler layer gaps:** Auth guards missing on new endpoints (11.1 critical), level fields missing from handler mapping (11.4) — the "thin adapter" layer is deceptively risky
3. **Story documentation drift:** 11.5 documented files that didn't exist (`teaser-portrait.haiku.repository.ts` vs actual `teaser-portrait.anthropic.repository.ts`). Entire review round spent on documentation fixes
4. **`data-testid` attributes replaced by `data-slot`:** Frontend work strips testing hooks, breaking e2e test selectors
5. **Epic 10 prep work incomplete:** 4 of 9 action items not addressed (architecture docs, CLAUDE.md cleanup, LangGraph removal)
6. **Parallelism pain:** Three concurrent workstreams (Epics 11, 13, 15) cause merge conflicts on shared infrastructure files (`index.ts`, `schema.ts`, barrel exports)

---

## Key Insights

1. **TDD correlates directly with code quality:** 11.3 (closest to TDD) had the cleanest review; 11.1 (no TDD) had 10 issues including 3 critical
2. **Anti-patterns catch but don't prevent:** Rules in stories identify issue categories, but review catches them after the fact — agent behavior must change at the instruction level
3. **Prep work tracking needs structure:** Action items from retros get lost between epics without a tracking mechanism
4. **Parallelism needs a plan, not just worktrees:** Git isolation isn't enough — architectural conflicts (shared files) need upfront mapping and merge sequencing
5. **`data-testid` vs `data-slot` distinction must be explicit:** Without a documented rule, agents treat them as interchangeable

---

## Epic 10 Retro Follow-Through

| # | Action Item | Status | Notes |
|---|-------------|--------|-------|
| 1 | Streamline workflow 6→3 passes | ✅ Completed | All 5 stories used new workflow |
| 2 | Anti-patterns in story template | ✅ Completed | All 5 stories had detailed sections |
| 3 | Dev agent self-check checklist | ⏳ Partial | Clean test/lint runs but review still catches same categories |
| 4 | Refresh docs/ARCHITECTURE.md | ❌ Not Addressed | Carried to Epic 12 |
| 5 | Consolidate aspirational architecture | ❌ Not Addressed | Carried to Epic 12 |
| 6 | Clean up CLAUDE.md | ❌ Not Addressed | Carried to Epic 12 |
| 7 | Fix mock typing (Context.Tag.Service) | ⏳ Partial | New mocks better but not enforced |
| 8 | Test architecture cleanup | ⏳ Partial | Test counts grew, no restructuring |
| 9 | Remove legacy LangGraph dead code | ❌ Not Addressed | Carried to Epic 12 |

**Score:** 2 completed, 3 partial, 4 not addressed

---

## Action Items

### Process Improvements

| # | Action Item | Owner | Priority | Success Criteria |
|---|-------------|-------|----------|------------------|
| 1 | Update dev agent instructions (`dev.md`) to mandate TDD sequence: write failing test → implement → verify pass | Bob (SM) | Critical | Dev agent writes tests before implementation in next epic |
| 2 | Add `data-testid` preservation rule to FRONTEND.md and CLAUDE.md: never remove/replace, coexists with `data-slot`, e2e tests use `data-testid` exclusively | Bob (SM) + Paige (Tech Writer) | Critical | Zero `data-testid` removals in next epic |
| 3 | SM produces/updates `sprint-parallelism-plan.md` at every sprint-planning — step-based format with parallelizable story batches per step, gate progression on batch completion | Bob (SM) | Critical | Plan exists and is refreshed at every sprint-planning before agents start work |

### Carried Over from Epic 10

| # | Action Item | Owner | Priority | Success Criteria |
|---|-------------|-------|----------|------------------|
| 4 | Refresh `docs/ARCHITECTURE.md` — current state of codebase | Winston (Architect) | High | Accurate reflection of what's built |
| 5 | Clean up CLAUDE.md — remove stale Phase 1/LangGraph patterns | Paige (Tech Writer) | High | Zero stale references |
| 6 | Remove legacy LangGraph dead code | Amelia (Dev) | Parallel | Zero orchestrator/LangGraph files remain |

### Technical Debt

| # | Action Item | Owner | Priority | Success Criteria |
|---|-------------|-------|----------|------------------|
| 7 | Add handler-level test coverage rule: every new endpoint must have auth guard test and field mapping test | Bob (SM) in anti-patterns | Medium | Handler gaps caught by tests, not review |
| 8 | Deprecate `session.personalDescription` in favor of `assessment_results.portrait` | Amelia (Dev) | Low | Single portrait source of truth |

---

## Sprint Parallelism Plan Format

The SM will produce/update `sprint-parallelism-plan.md` **at every sprint-planning session** covering **upcoming stories only** (not already-completed work). Uses a step-based batch model:

```
STEP 1: [description]
  Stories (parallel): 11-1, 13-2, 15-1
  Gate: all 3 stories must reach "done" before proceeding

STEP 2: [description]
  Stories (parallel): 11-2, 13-3
  Stories (sequential): 11-3 (depends on 11-2)
  Gate: all stories must reach "done" before proceeding

STEP 3: ...

CONFLICT NOTES
  Shared files affected per step, merge order within step if needed
```

Key principles:
- **Step-based gating:** all stories in a step must be done before the next step begins
- **Stories within a step run in parallel** — agents work concurrently on independent stories
- **Sequential dependencies within a step** are explicitly marked
- **Refreshed at every sprint-planning** — not a one-time artifact
- Story-level granularity (not epic-level)
- Don't force parallelism — split where natural, sequence where needed

---

## Readiness Assessment

| Area | Status |
|------|--------|
| Testing & Quality | ✅ All tests passing (241+ API, 200 frontend, 733+ domain) |
| Deployment | ⏳ Not yet deployed — Epic 11 code in worktree |
| Stakeholder Acceptance | ✅ Vincentlay confirmed satisfied |
| Technical Health | ✅ Stable — idempotency proven, clean architecture |
| Unresolved Blockers | ⚠️ Architecture docs still stale (carried over) |

---

## Next Steps

1. **Merge Epic 11 worktree to master**
2. **Execute action items #1-3** (dev agent TDD, data-testid rule, parallelism plan)
3. **Produce sprint-parallelism-plan.md** for current active work (Epics 12, 13, 15)
4. **Address carried-over items** (#4-6) when capacity allows
5. **Continue parallel epic work** with proper parallelism tracking
